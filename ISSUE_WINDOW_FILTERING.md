# Issue: 实现 KNN 距离计算的窗口筛选优化

## 📋 问题背景

当前 `knn_local.py` 中的 KNN 距离计算采用全量计算方式：
- **问题**：对每个查询点，与所有训练点计算距离
- **复杂度**：O(Q × N)，其中 Q 是查询点数，N 是训练点数
- **性能**：对于大规模数据（N > 50,000），耗时较长

**示例**：
- N=100,000, Q=10,000
- 需要计算 **10^9 次距离**
- 即使使用 GPU 加速，仍然需要较长时间

## 🎯 优化目标

通过**风速和空气密度范围**预筛选候选点，减少距离计算量。

### 核心思想

对于查询点 `(ws_q, rho_q)`，只考虑满足以下条件的候选点：
```
ws_q - window_v ≤ ws_c ≤ ws_q + window_v
rho_q - window_r ≤ rho_c ≤ rho_q + window_r
```

**物理意义**：只有工况相似的点才有可比性。

## 📝 实施要求

### 1. 修改位置

**文件**：`stage2_modular/thresholds/knn_local.py`

**函数**：`KNNLocal.compute()` 方法中的距离计算部分

### 2. 实施方案

#### 方案：窗口筛选 + 距离计算

**步骤**：
1. 对每个查询点，根据风速和密度范围筛选候选点
2. 只在筛选后的候选集上计算距离
3. 从筛选后的结果中选择 K 个最近邻

**伪代码**：
```python
for query_point in query_X:
    # 步骤1：窗口筛选
    mask = (abs(train_X[:, 0] - query_point[0]) <= window_v) & \
           (abs(train_X[:, 1] - query_point[1]) <= window_r)
    candidates_idx = np.where(mask)[0]
    
    # 步骤2：距离计算（只在候选集上）
    candidates = train_X[candidates_idx]
    distances = compute_distance(candidates, query_point)
    
    # 步骤3：选择 K 近邻
    topk_idx = np.argsort(distances)[:K]
    neighbors_idx = candidates_idx[topk_idx]
```

#### 边界处理

**若候选不足 K 个**：
- 自动扩大窗口（window × 1.5）
- 最多扩展 3 次
- 仍不足则使用全量计算（保证鲁棒性）

### 3. 配置参数

在 JSON 配置文件的 `defaults.thresholds` 部分添加：

```json
{
  "thresholds": {
    "use_window_filter": true,
    "window_v": 0.1,
    "window_r": 0.2,
    "min_candidates": 1000
  }
}
```

**参数说明**：
- `window_v`：风速窗口半径（标准化空间）
  - MinMax [0,1]: 0.1 约对应 ±1.5 m/s
  - Z-score: 0.5 约对应 0.5σ
  
- `window_r`：空气密度窗口半径（标准化空间）
  - MinMax [0,1]: 0.2 约对应 ±0.06 kg/m³
  - Z-score: 1.0 约对应 1.0σ
  
- `min_candidates`：最小候选数（建议 K×2 或 1000）

### 4. 不需要的功能

❌ **不需要 KDTree**
- 窗口筛选已经足够有效
- 避免增加代码复杂度
- GPU 和 CPU 都可以使用

❌ **不需要额外依赖**
- 只使用 NumPy/PyTorch 基本功能
- 保持代码简洁

## 📊 预期效果

### 性能提升

| 指标 | 优化前 | 优化后 | 改进 |
|------|--------|--------|------|
| 候选点数 | N (100%) | M (20-50%) | 50-80% 筛除 |
| 距离计算量 | Q × N | Q × M | 2-5x 减少 |
| 总耗时 | T | 0.5-0.7T | 1.5-2x 提速 |

### 筛选效果示例

**数据规模**：N=50,000, Q=5,000, K=500

| 窗口大小 | 平均候选数 | 筛除率 |
|---------|-----------|--------|
| 0.1/0.2 | 10,000-15,000 | 70-80% |
| 0.15/0.25 | 15,000-20,000 | 60-70% |
| 0.2/0.3 | 20,000-25,000 | 50-60% |

## ✅ 验证方法

### 1. 功能验证

**测试脚本**：
```python
# 验证窗口筛选的正确性
python test_window_filtering.py
```

**检查**：
- 筛选后的候选点确实在窗口范围内
- K 近邻结果与全量计算一致（或非常接近）
- 边界情况处理正确

### 2. 性能对比

**对比测试**：
```bash
# 无优化（基线）
python main.py --config config_baseline.json

# 窗口筛选优化
python main.py --config config_window_filter.json
```

**配置差异**：
```json
// config_baseline.json
{"use_window_filter": false}

// config_window_filter.json
{"use_window_filter": true, "window_v": 0.1, "window_r": 0.2}
```

**记录指标**：
- 总运行时间
- KNN 阶段耗时
- 平均候选筛除率
- 最终结果一致性

### 3. 结果对比

**输出对比**：
- 异常标记结果是否一致（允许 <5% 差异）
- 清洗后的数据质量
- 运行日志中的性能指标

## 📝 实施步骤

### 阶段 1：核心实现

1. [ ] 在 `knn_local.py` 中添加窗口筛选函数
2. [ ] 集成到距离计算流程
3. [ ] 实现自动扩展窗口机制
4. [ ] 添加配置参数解析

### 阶段 2：测试验证

1. [ ] 创建测试脚本验证正确性
2. [ ] 运行小规模数据测试
3. [ ] 验证结果一致性

### 阶段 3：性能对比

1. [ ] 准备对比配置文件
2. [ ] 运行基线测试（无优化）
3. [ ] 运行优化测试（窗口筛选）
4. [ ] 记录和对比性能指标

### 阶段 4：文档更新

1. [ ] 更新 README.md
2. [ ] 添加配置参数说明
3. [ ] 提供使用示例

## 🎯 验收标准

### 必须满足

- [x] 实现窗口筛选功能
- [x] 配置参数可调
- [x] 处理候选不足的边界情况
- [x] 提供性能对比数据
- [x] 结果一致性验证（<5% 差异）

### 性能目标

- [x] 候选筛除率：50-80%
- [x] 性能提升：1.5-2x
- [x] GPU 和 CPU 都支持

### 代码质量

- [x] 代码简洁，易于维护
- [x] 添加必要的注释
- [x] 无需额外依赖

## 📚 参考资料

### 相关文件

- `stage2_modular/thresholds/knn_local.py` - KNN 实现
- `experiments_compare_不同切向比例_分风机_JSMZS51-58.json` - 配置文件
- `main.py` - 主入口

### 文档

- `README.md` - 项目说明
- `USER_GUIDE.md` - 使用指南

## 💡 注意事项

### 重要提示

1. **基于 main 分支**
   - 不使用之前的优化分支
   - 从干净的 main 分支开始

2. **只修改距离计算**
   - 不改变其他逻辑
   - 保持代码简洁

3. **保持向后兼容**
   - 默认启用窗口筛选
   - 可以通过配置禁用

4. **GPU 支持**
   - 窗口筛选在 GPU 上也有效
   - 不限制设备类型

### 常见问题

**Q: 窗口大小如何选择？**
A: 
- 默认值（0.1/0.2）适合大多数情况
- 数据密集：减小窗口（0.05/0.1）
- 数据稀疏：增大窗口（0.15/0.25）

**Q: 如果筛选后不足 K 个怎么办？**
A: 自动扩大窗口，最多3次，仍不足则用全量计算

**Q: 会影响结果准确性吗？**
A: 
- 理论上：可能略有差异（物理上合理）
- 实测：差异 <5%，可接受
- 本质：相似工况才有可比性

**Q: 为什么不用 KDTree？**
A: 
- 窗口筛选已经很有效（50-80% 筛除）
- 更简单，易于理解和维护
- GPU 和 CPU 都适用
- 无需额外依赖

## 🚀 期望产出

### 代码修改

- `stage2_modular/thresholds/knn_local.py`（+100-150行）
- 配置文件示例

### 测试脚本

- `test_window_filtering.py`（功能验证）

### 性能报告

- 基线 vs 优化的耗时对比
- 候选筛除率统计
- 结果一致性分析

### 文档

- README.md 更新
- 配置参数说明
- 使用示例

---

## 标签

`enhancement` `performance` `knn` `optimization`

## 优先级

**High** - 性能优化，用户强烈需求

## 里程碑

Version 2.0 - Performance Optimization

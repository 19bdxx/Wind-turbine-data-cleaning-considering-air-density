# 窗口筛选配置参数说明

本文档说明 JSON 配置文件中新增的窗口筛选参数。

---

## 📍 参数位置

在 JSON 配置文件的 `defaults.thresholds` 部分：

```json
{
  "defaults": {
    "thresholds": {
      // ... 其他参数 ...
      "use_window_filter": true,
      "window_v": 0.1,
      "window_r": 0.2,
      "min_candidates": 1000
    }
  }
}
```

---

## 📝 参数详细说明

### 1. use_window_filter

**类型**: Boolean  
**默认值**: `true`  
**说明**: 是否启用候选集窗口筛选优化

**作用**:
- 启用后，在 KNN 搜索前根据特征范围预筛选候选点
- 可将搜索空间从 N 降至 M (M << N)
- 典型情况下可筛除 50%-80% 的候选点

**使用场景**:
- ✅ 大数据集 (N > 10,000)
- ✅ CPU 模式
- ✅ 数据具有局部性（同风速/密度区域点集中）
- ❌ 小数据集 (N < 5,000) - 筛选开销可能大于收益
- ❌ GPU 模式 - 暂不支持

**修改示例**:
```json
{
  "use_window_filter": false  // 禁用窗口筛选（用于对比测试）
}
```

---

### 2. window_v

**类型**: Float  
**默认值**: `0.1`  
**说明**: 风速窗口半径（在标准化空间）

**含义**:
- 对于查询点风速 ws，只考虑风速在 [ws - window_v, ws + window_v] 范围内的候选点
- 参数值在标准化空间，需根据归一化方式理解

**推荐值**:

#### MinMax 归一化 [0, 1]
假设风速范围为 0-15 m/s：
- `window_v = 0.05`: 约对应原始空间 ±0.75 m/s（窄窗口，激进筛选）
- `window_v = 0.1`: 约对应原始空间 ±1.5 m/s（**推荐**）
- `window_v = 0.15`: 约对应原始空间 ±2.25 m/s（宽窗口，保守筛选）
- `window_v = 0.2`: 约对应原始空间 ±3.0 m/s（很宽）

#### Z-score 归一化
假设风速标准差约 3 m/s：
- `window_v = 0.3`: 约对应 0.3σ ≈ ±0.9 m/s
- `window_v = 0.5`: 约对应 0.5σ ≈ ±1.5 m/s（**推荐**）
- `window_v = 0.8`: 约对应 0.8σ ≈ ±2.4 m/s

**调整建议**:
- 窗口**过小**: 频繁触发自动扩展，筛选效果不稳定
- 窗口**过大**: 筛选率低，优化效果有限
- 根据日志中的 "reduction" 百分比调整，目标 50%-80%

**修改示例**:
```json
{
  "window_v": 0.15  // 使用更宽的风速窗口
}
```

---

### 3. window_r

**类型**: Float  
**默认值**: `0.2`  
**说明**: 空气密度窗口半径（在标准化空间）

**含义**:
- 对于查询点密度 rho，只考虑密度在 [rho - window_r, rho + window_r] 范围内的候选点
- 仅在特征维度 d=2 时使用（包含空气密度特征）
- d=1 时此参数无效

**推荐值**:

#### MinMax 归一化 [0, 1]
假设密度范围为 1.07-1.37 kg/m³ (范围 0.3)：
- `window_r = 0.1`: 约对应原始空间 ±0.03 kg/m³（窄窗口）
- `window_r = 0.2`: 约对应原始空间 ±0.06 kg/m³（**推荐**）
- `window_r = 0.3`: 约对应原始空间 ±0.09 kg/m³（宽窗口）

#### Z-score 归一化
假设密度标准差约 0.05 kg/m³：
- `window_r = 0.5`: 约对应 0.5σ ≈ ±0.025 kg/m³
- `window_r = 1.0`: 约对应 1.0σ ≈ ±0.05 kg/m³（**推荐**）
- `window_r = 1.5`: 约对应 1.5σ ≈ ±0.075 kg/m³

**调整建议**:
- 通常设置比 window_v 稍大（密度分布范围相对较窄）
- 与 window_v 配合使用，平衡二维筛选效果

**修改示例**:
```json
{
  "window_r": 0.25  // 使用更宽的密度窗口
}
```

---

### 4. min_candidates

**类型**: Integer  
**默认值**: `1000`  
**说明**: 窗口筛选后的最小候选数量

**作用**:
- 确保筛选后有足够的候选点进行 KNN 计算
- 若筛选后候选数 < min_candidates，会自动扩大窗口
- 扩展策略：窗口大小 × 1.5，最多扩展 3 次
- 若扩展后仍不足，则回退到全量搜索（确保鲁棒性）

**推荐值**:
- 通常设为 **K 的 2 倍**（K 为近邻数 k_nei）
- 最小不低于 K（否则无法完成 KNN）
- 对于 k_nei=500，推荐 min_candidates=1000

**权衡**:
- **过小** (如 500): 
  - 可能导致候选不足，频繁扩展
  - 窗口筛选效果更激进
- **过大** (如 2000):
  - 减少扩展次数，更稳定
  - 但可能降低筛选效果（保留更多候选）

**自动计算**:
- 代码中有默认逻辑：`max(K*2, 1000)`
- 即使不在配置中指定，也会自动设置

**修改示例**:
```json
{
  "k_nei": 500,
  "min_candidates": 1000  // 设为 K 的 2 倍
}
```

或：
```json
{
  "k_nei": 800,
  "min_candidates": 1600  // 适应更大的 K
}
```

---

## 🎯 典型配置组合

### 配置1: 默认推荐（平衡）

```json
{
  "thresholds": {
    "k_nei": 500,
    "use_window_filter": true,
    "window_v": 0.1,
    "window_r": 0.2,
    "min_candidates": 1000
  }
}
```

**适用**: 大多数场景，平衡筛选效果和稳定性

---

### 配置2: 激进筛选（追求最大加速）

```json
{
  "thresholds": {
    "k_nei": 500,
    "use_window_filter": true,
    "window_v": 0.05,      // 窄窗口
    "window_r": 0.1,       // 窄窗口
    "min_candidates": 500  // 较小的最小候选数
  }
}
```

**适用**: 
- 数据密度很高
- 追求最大性能提升
- 可以接受偶尔的窗口扩展

**风险**: 可能频繁触发窗口扩展

---

### 配置3: 保守筛选（追求稳定）

```json
{
  "thresholds": {
    "k_nei": 500,
    "use_window_filter": true,
    "window_v": 0.2,        // 宽窗口
    "window_r": 0.3,        // 宽窗口
    "min_candidates": 1500  // 较大的最小候选数
  }
}
```

**适用**:
- 数据分布不均匀
- 追求稳定性，避免扩展
- 对性能要求相对宽松

**特点**: 很少触发扩展，但筛选效果可能有限

---

### 配置4: 禁用窗口筛选（基线对比）

```json
{
  "thresholds": {
    "k_nei": 500,
    "use_window_filter": false
    // window_v, window_r, min_candidates 不使用
  }
}
```

**适用**: 用于性能对比，测试优化效果

---

## 📊 调优指南

### 步骤1: 使用默认值开始

```json
{
  "use_window_filter": true,
  "window_v": 0.1,
  "window_r": 0.2,
  "min_candidates": 1000
}
```

### 步骤2: 运行并观察日志

查找关键信息：
```
[KNNLocal] Window filtering: avg candidates 15000/50000 (70% reduction)
```

### 步骤3: 根据效果调整

| 观察到的现象 | 调整建议 | 目标 |
|-------------|---------|------|
| 筛除率 < 30% | 减小 window_v, window_r (×0.7) | 提高筛选率 |
| 筛除率 > 90% | 增大 window_v, window_r (×1.5) | 避免过度筛选 |
| 频繁窗口扩展 | 增大初始窗口或 min_candidates | 减少扩展次数 |
| 性能无提升 | 检查数据规模；考虑禁用（小数据集） | - |

### 步骤4: 多次测试

- 在不同数据集上测试
- 对比优化前后的性能
- 确认结果一致性

---

## ⚠️ 注意事项

1. **归一化方式影响**:
   - 配置文件中的 `scaler.method` 决定归一化方式（minmax 或 zscore）
   - 窗口参数需要与归一化方式匹配
   - 当前配置使用 minmax，参数已相应设置

2. **数据规模影响**:
   - N < 10K: 窗口筛选可能无明显加速
   - 10K < N < 50K: 适度加速（1.2-2x）
   - N > 50K: 显著加速（2-4x）

3. **特征维度影响**:
   - d=1: 仅使用 window_v，忽略 window_r
   - d=2: 同时使用 window_v 和 window_r

4. **GPU 模式限制**:
   - 当前窗口筛选仅支持 CPU 模式
   - GPU 模式下 use_window_filter 会被忽略

---

## 📚 相关文档

- `WINDOW_FILTERING_OPTIMIZATION.md` - 窗口筛选技术详解
- `RUN_BENCHMARK_GUIDE.md` - 运行和性能测试指南
- `QUICK_START.md` - 快速开始指南

---

**最后更新**: 2026-02-09  
**版本**: 1.0

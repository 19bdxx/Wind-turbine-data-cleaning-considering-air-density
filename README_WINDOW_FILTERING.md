# KNN 窗口筛选优化

## 概述

本文档描述了在 `stage2_modular/thresholds/knn_local.py` 中实现的窗口筛选优化，用于改善大型数据集的 KNN 距离计算性能。

## 问题陈述

原始的 KNN 实现计算所有查询点和所有训练点之间的距离（O(Q × N) 复杂度），这对于大型数据集来说开销很大：

- 对于 N=100,000 个训练点和 Q=10,000 个查询点
- 会产生 10^9 次距离计算
- 即使使用 GPU 加速，也需要相当长的时间

## 解决方案：基于窗口的预筛选

该优化在计算距离之前，根据风速和空气密度范围预筛选候选点。

### 核心概念

对于每个查询点 `(ws_q, rho_q)`，只考虑满足以下条件的候选点：
```
ws_q - window_v ≤ ws_c ≤ ws_q + window_v
rho_q - window_r ≤ rho_c ≤ rho_q + window_r
```

**物理依据**：只有来自相似运行条件的点才具有可比性。

## 配置参数

在 JSON 配置文件的 `defaults.thresholds` 下添加这些参数：

```json
{
  "thresholds": {
    "use_window_filter": true,
    "window_v": 0.1,
    "window_r": 0.2,
    "min_candidates": 1000,
    ...
  }
}
```

### 参数详情

| 参数 | 类型 | 默认值 | 描述 |
|-----------|------|---------|-------------|
| `use_window_filter` | 布尔值 | `true` | 启用/禁用窗口筛选 |
| `window_v` | 浮点数 | `0.1` | 风速窗口半径（归一化空间） |
| `window_r` | 浮点数 | `0.2` | 空气密度窗口半径（归一化空间） |
| `min_candidates` | 整数 | `1000` | 最小候选数阈值 |

### 选择窗口大小

窗口参数位于**归一化空间**（例如，MinMax [0,1] 或 Z-score）：

**对于 MinMax 归一化 [0,1]：**
- `window_v = 0.1` ≈ 物理空间中的 ±1.5 m/s
- `window_r = 0.2` ≈ 物理空间中的 ±0.06 kg/m³

*注意：这些转换假设主配置文件中的缩放器配置：*
- *`wind_range: [0, 15]` → 15 m/s 全范围 → 0.1 × 15 = 1.5 m/s*
- *`rho_range: [1.07, 1.37]` → 0.3 kg/m³ 全范围 → 0.2 × 0.3 = 0.06 kg/m³*
- *您的转换可能会因缩放器设置而有所不同*

**对于 Z-score 归一化：**
- `window_v = 0.5` ≈ 0.5σ（标准差）
- `window_r = 1.0` ≈ 1.0σ

**指南：**
- **密集数据**：使用较小的窗口（0.05/0.1）以进行更精细的筛选
- **稀疏数据**：使用较大的窗口（0.15/0.25）以确保足够的候选点
- **默认值**（0.1/0.2）适用于大多数情况

## 自动窗口扩展

如果筛选出的候选数量少于 `max(K_NEI, min_candidates)`：

1. **扩展窗口**：乘以 1.5
2. **使用更大的窗口重试筛选**
3. **最多 3 次扩展**（1.5×、2.25×、3.375×）
4. **回退**：如果仍然不足，使用所有候选点（完整计算）

这确保了鲁棒性，同时保持性能优势。

## 使用方法

### 基本使用

使用优化配置（启用窗口筛选）：

```bash
python main.py --config experiments_compare_不同切向比例_分风机_JSMZS51-58.json
```

### 基线对比

比较有无窗口筛选的性能：

```bash
# 基线（无优化）
python main.py --config config_baseline.json

# 优化版本（使用窗口筛选）
python main.py --config config_window_filter.json
```

### 测试窗口筛选

验证窗口筛选实现：

```bash
# 注意：需要安装 numpy 和 torch
python test_window_filtering.py
```

## 性能监控

实现会记录性能统计信息：

```
[KNNLocal] Window filtering enabled: window_v=0.1, window_r=0.2, min_candidates=1000
[KNNLocal] Window filtering stats: avg_candidates=5234.2/50000 (89.5% filtered), expansions=12/10000
```

**解释：**
- `avg_candidates`：筛选后每个查询的平均候选数
- `% filtered`：筛选掉的总候选点百分比
- `expansions`：需要窗口扩展的查询数量

**预期结果：**
- **筛选率**：对于调整良好的窗口为 80-95%
- **扩展次数**：<5% 的查询需要扩展
- **加速**：对于大型数据集（N > 50,000）快 5-20 倍

## 实现细节

### 函数：`_window_filter_candidates()`

位于 `stage2_modular/thresholds/knn_local.py`：

```python
def _window_filter_candidates(Zb_t, Xcand_t, window_v, window_r, d, 
                               min_candidates, K_NEI):
    """
    根据窗口约束为每个查询点筛选候选点。
    
    返回：
        filtered_indices：每个查询的候选索引列表
        expand_count：需要扩展的查询数量
    """
```

### 集成点

1. **配置解析**（约 230-235 行）：读取窗口筛选参数
2. **状态日志**（约 370-375 行）：报告筛选状态
3. **主循环**（约 440-515 行）：对每个查询批次应用筛选
4. **统计信息**（约 540-545 行）：报告最终统计

## 向后兼容性

- **默认行为**：启用窗口筛选
- **禁用选项**：在配置中设置 `use_window_filter: false`
- **原始代码路径**：禁用筛选时保留
- **无破坏性更改**：现有配置无需修改即可工作

## 处理的边缘情况

1. **候选不足**：自动窗口扩展
2. **稀疏数据区域**：如需要则回退到完整计算
3. **1D vs 2D 数据**：正确处理仅风速和风速+密度情况
4. **设备兼容性**：同时适用于 CPU 和 GPU

## 故障排除

### 候选太少（多次扩展）

**症状**：日志中扩展次数很高

**解决方案：**
- 增加 `window_v` 和 `window_r`（例如，0.15、0.25）
- 减少 `min_candidates`（例如，500）
- 检查数据分布是否有异常值

### 无性能改进

**症状**：有无筛选运行时间相似

**可能原因：**
- 窗口太大（筛选掉的候选点很少）
- 数据集太小（开销占主导）
- 数据密集（大多数点都在窗口内）

**解决方案：**
- 减小窗口大小
- 检查日志中的筛选率（应 >50%）
- 窗口筛选对 N > 50,000 最有利

### 结果与基线不同

**预期**：最终结果差异 <5%
**原因**：略有不同的邻居集（物理上合理）
**措施**：如果差异 >5%，增加窗口大小

## 性能预期

### 大型数据集 (N=100,000, Q=10,000)

| 配置 | 距离计算 | 预期时间 | 加速 |
|---------------|----------------|---------------|---------|
| 无筛选 | 10^9 | ~300秒 | 1× |
| 窗口筛选（减少 90%） | 10^8 | ~30秒 | **10×** |

### 中型数据集 (N=50,000, Q=5,000)

| 配置 | 距离计算 | 预期时间 | 加速 |
|---------------|----------------|---------------|---------|
| 无筛选 | 2.5×10^8 | ~60秒 | 1× |
| 窗口筛选（减少 85%） | 3.75×10^7 | ~10秒 | **6×** |

*注意：实际加速取决于硬件、数据分布和窗口参数。*

## 未来改进

潜在的增强功能（当前未实现）：

1. **自适应窗口**：根据数据密度自动调整
2. **空间索引**：使用 KD-tree 或 ball-tree 加快筛选速度
3. **批量筛选**：一次筛选所有查询（需要更多内存）
4. **GPU 核心**：用于筛选的自定义 CUDA 核心

## 参考资料

- 原始问题："knn数据选择"（KNN 数据选择优化）
- 文件：`stage2_modular/thresholds/knn_local.py`
- 测试：`test_window_filtering.py`
- 配置：`config_baseline.json`、`config_window_filter.json`

## 联系方式

如有问题或疑问，请在 GitHub 上提交 issue 或联系维护者。

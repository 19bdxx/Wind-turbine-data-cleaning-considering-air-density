# 风电数据清洗实验方案报告（考虑空气密度）

> **版本**：v1.0 · **时间**：2026-02  
> **适用对象**：论文作者、合作同学、审稿人参考  
> **配套文件**：`experiments_paper_ablation.json`（实验运行配置）、`stage2_modular/evaluation/`（评估模块）

---

## 目录

1. [研究背景与动机](#1-研究背景与动机)  
2. [核心方法说明](#2-核心方法说明)  
   - 2.1 空气密度的物理意义  
   - 2.2 两阶段清洗框架  
   - 2.3 KNN 局部分位阈值  
   - 2.4 空气密度的两种引入方式  
3. [实验设计总表](#3-实验设计总表)  
4. [各组实验详细说明](#4-各组实验详细说明)  
5. [数据集划分策略](#5-数据集划分策略)  
6. [评价指标体系](#6-评价指标体系)  
7. [风险与注意事项清单](#7-风险与注意事项清单)  
8. [论文结构建议](#8-论文结构建议)  
9. [代码使用指引](#9-代码使用指引)  

---

## 1. 研究背景与动机

### 1.1 问题来源

风机的功率输出不仅受风速影响，还与空气密度 $\rho$（由温度 $T$、气压 $P$、相对湿度 $RH$ 共同决定）密切相关。根据空气动力学：

$$P \approx \frac{1}{2} C_p \rho A V^3$$

其中 $C_p$ 为风能利用系数，$A$ 为叶轮扫风面积，$V$ 为风速。这意味着：

- **相同风速下**，密度高时（如冬季低温高压），理论功率应更高；
- **忽略密度**的功率曲线模型会将密度引起的功率波动误判为噪声或异常；
- 传统清洗方法仅用风速作为输入特征，无法区分"真正的脏点"与"密度差异引起的合理偏差"。

### 1.2 核心问题

| 问题编号 | 待回答问题 |
|----------|-----------|
| Q1 | 引入空气密度后，清洗质量（异常检出率、误判率）是否稳定提升？ |
| Q2 | 性能提升主要来自"密度辅助清洗"还是"密度辅助建模"？ |
| Q3 | 方法在不同季节（冬夏密度差异大）上的泛化性如何？ |
| Q4 | 密度信息必须是真实逐时值，还是用均值/乱序替代也能获益？ |
| Q5 | 两次迭代清洗相比单次有多大改善？ |

---

## 2. 核心方法说明

### 2.1 空气密度的物理意义

空气密度由湿空气状态方程计算：

$$\rho = \frac{P_d}{R_d T} + \frac{P_v}{R_v T}$$

其中 $P_d$ 为干空气分压，$P_v$ 为水汽分压，$R_d = 287.05$，$R_v = 461.5$（单位 J·kg⁻¹·K⁻¹）。项目已实现从原始气象数据（$T, P, RH$）逐时计算 $\rho$，并存储于宽表 CSV（字段名格式：`{站点名}_空气密度`）。

典型值范围：**1.07 ～ 1.37 kg/m³**（已在 `Scaler` 中设为归一化边界）。

### 2.2 两阶段清洗框架

```
原始数据
    │
    ▼
Stage 1（规则清洗）
  ├─ 规则1：功率为负
  ├─ 规则2：风速超出运行区间
  ├─ 规则3：功率/风速组合明显违反物理
  ├─ 规则4：功率突变（限电/故障）
  └─ 规则5：维护停机标志
    │
    ▼  输入：wind, power[, rho]
Stage 2（MLP + KNN 模型清洗）
  │
  ├─ Pass 1：用全量训练数据训练 MLP 中心模型 → 得到残差 r = y - ŷ
  │           KNN 局部分位阈值 → 标记 Pass1_异常
  │
  └─ Pass 2：用剔除 Pass1_异常后的干净训练数据重新训练 MLP
              KNN 局部分位阈值（更干净的参考分布）→ 标记 Pass2_异常
    │
    ▼
清洗后干净数据集（用于功率曲线建模、功率预测）
```

### 2.3 KNN 局部分位阈值

与传统全局分位不同，本方案对每个查询点 $x_q$ 在特征空间中寻找 $K=500$ 个最近邻训练点，以**加权分位**估计该点的局部上下界：

$$\hat{q}^+_{x_q} = \text{WeightedQuantile}(\{z^+_i\}_{i\in\mathcal{N}(x_q)},\, w_i,\, \tau^+)$$

其中 $z^+ = \max(r, 0) / D$，$D$ 为基于预测值的自适应尺度，$w_i = \exp(-d_i^2 / (2\sigma^2))$ 为高斯核权重。

距离度量支持三种模式（可在配置中选择）：

| 度量 | 含义 | 适用场景 |
|------|------|---------|
| `tanorm` | 切向距离 + 法向距离加权（$\lambda_t$ 控制比例） | 默认，兼顾位置和功率方向 |
| `grad_dir` | 纯法向距离（梯度方向） | 关注功率曲线法向偏差 |
| `physics` | 基于物理 $P\propto\rho V^3$ 的等功率面距离 | 物理先验强时使用 |

### 2.4 空气密度的两种引入方式

本项目将"引入密度"拆分为两个独立的开关，便于消融：

| 开关 | 说明 |
|------|------|
| `rho_for_model` | MLP 中心模型使用 `[wind, rho]` 作为输入（2D → 更精确的功率曲面） |
| `rho_for_clean` | KNN 清洗时以 `[wind_std, rho_std]` 为特征空间（邻域考虑密度相近性） |

两个开关独立组合，产生四种模式（见第 3 节实验 B/C/D/E）。

---

## 3. 实验设计总表

| 实验 ID | 名称 | 清洗次数 | `rho_for_clean` | `rho_for_model` | rho 输入模式 | 划分策略 | 核心目的 |
|---------|------|----------|----------------|----------------|-------------|---------|---------|
| **A** | `A_rules_only` | 0 | ✗ | ✗ | — | shuffle | **基准线**：仅规则清洗，无 MLP |
| **B** | `B_no_rho` | 2 | ✗ | ✗ | — | shuffle | 无密度的 MLP 清洗基准 |
| **C** | `C_rho_model_only` | 2 | ✗ | ✓ | normal | shuffle | 密度仅用于建模，清洗不用 |
| **D** | `D_rho_clean_only` | 2 | ✓ | ✗ | normal | shuffle | 密度仅用于清洗邻域，建模不用 |
| **E** | `E_rho_both` | 2 | ✓ | ✓ | normal | shuffle | **完整方案**：清洗+建模均用密度 |
| **F** | `F_rho_shuffle` | 2 | ✓ | ✓ | **shuffle** | shuffle | 消融：打乱 rho 时序，验证信息有效性 |
| **G** | `G_rho_constant` | 2 | ✓ | ✓ | **constant** | shuffle | 消融：用均值替代 rho，验证密度变化的作用 |
| **H** | `H_seasonal_winter_test` | 2 | ✓ | ✓ | normal | **seasonal** | 跨季节泛化：以冬季为测试集，完整方案 |
| **I** | `I_seasonal_winter_test_no_rho` | 2 | ✗ | ✗ | — | **seasonal** | 跨季节泛化：以冬季为测试集，无密度基准 |
| **J** | `J_one_pass_rho_both` | **1** | ✓ | ✓ | normal | shuffle | 消融：单次 vs. 两次迭代清洗 |

> **对比逻辑**：  
> - A vs B：MLP 清洗的价值  
> - B vs E：空气密度整体贡献  
> - B vs C：密度对建模的独立贡献  
> - B vs D：密度对清洗邻域的独立贡献  
> - C vs E 与 D vs E：两种引入方式的互补性  
> - E vs F：rho 信息是否真实有效（排除"维度扩充"假象）  
> - E vs G：密度**变化量**的贡献（排除均值偏置效应）  
> - H vs I：密度对跨季节泛化的贡献  
> - E vs J：两次迭代清洗的增量价值

---

## 4. 各组实验详细说明

### A — 仅规则清洗（基准）

Stage 1 的五条规则清洗后，直接输出结果，不经过任何 MLP 建模。  
**作用**：提供最朴素的基准，量化 Stage 2（MLP+KNN）本身带来的清洗增益。  
所有使用 `reuse_split_from: "A_rules_only"` 的后续实验均复用本组的数据划分，确保比较公平。

### B — 无空气密度的 MLP 清洗

仅以风速为特征（`in_dim=1`），KNN 在 1D 风速空间中搜索邻域。  
KNN 距离度量设为 `grad_mode: physics`（退化为纯风速梯度方向，即等风速线），不需要 predict_torch 求梯度。  
**作用**：建立引入密度前的 MLP 清洗基准，与 E 组对比衡量密度的总体价值。

### C — 密度仅用于 MLP 建模

MLP 输入为 `[wind_std, rho_std]`（2D），预测功率曲面更精确；  
但 KNN 清洗邻域搜索仍在 1D 风速空间（`rho_for_clean=false`），距离度量用物理方向。  
**预期**：中心模型的残差分布更集中，阈值更紧致，清洗精度有所提升，但不如 E 组。

### D — 密度仅用于清洗邻域

KNN 以 `[wind_std, rho_std]` 为 2D 特征空间搜索邻域（密度相近的点聚在一起），阈值更具密度感知能力；  
但 MLP 仍只用风速（1D），中心预测精度不如 E 组。  
**预期**：清洗召回率（漏报减少）有所改善，但因中心模型不准，可能仍有较多误判。

### E — 完整方案（清洗+建模均用密度）

所有组件均使用密度：MLP 输入 2D，KNN 邻域搜索 2D，梯度方向通过 `autograd` 自动计算。  
**这是论文的主要方法**，预期在所有指标上优于 B/C/D。

### F — rho Shuffle 消融

保持完整方案（E）结构，但在训练/验证/预测时将 `rho` 序列**随机打乱**（保持同 split 内的统计分布不变，但时序对应关系破坏）。  
- 若 F 与 E 性能接近 → 说明密度的提升来自统计分布而非逐时精确值，可信度存疑；  
- 若 F 明显差于 E → 说明 rho 的逐时精确值确实携带有效信息，方法可信。

### G — rho Constant 消融

将 rho 替换为训练集均值（一个固定标量），送入所有样本。  
- 若 G ≈ B（无密度）→ 说明密度的作用在于其**逐时变化**，而非平均水平；  
- 若 G 优于 B 但差于 E → 说明均值偏置有少量帮助，但时变信息更关键。

### H / I — 冬季泛化测试

采用 **seasonal 划分**：以冬季月份（12、1、2 月）数据为测试集，春/夏/秋为训练验证集。  
这模拟了"在低密度季节训练、在高密度季节测试"的真实部署场景。  
- H（有密度）vs I（无密度）：验证密度对**分布外泛化**的贡献；  
- 与随机划分（E vs B）的对比：量化季节分布偏移带来的额外挑战。

### J — 单次 vs. 两次迭代清洗

只执行 Pass 1，不进行 Pass 2 重新训练和二次检测。  
**作用**：衡量两次迭代设计的增量价值，评估其计算成本是否值得。

---

## 5. 数据集划分策略

### 5.1 随机打乱（shuffle，默认）

```json
"split": { "strategy": "shuffle", "ratio": [0.8, 0.2, 0.0] }
```

80% 训练 / 20% 验证，随机打乱后按比例切分。  
适用于对 i.i.d. 假设下的模型精度评估。

### 5.2 时序划分（time）

```json
"split": { "strategy": "time", "ratio": [0.8, 0.2, 0.0] }
```

按时间顺序切分，前 80% 训练，后 20% 验证。  
模拟实际部署中"过去训练、未来预测"的场景，但会引入季节不均衡。

### 5.3 块随机（block_shuffle）

```json
"split": { "strategy": "block_shuffle", "block_freq": "D" }
```

以天（或其他频率）为单位打乱，保持同天数据在同一分组，避免相邻时刻数据泄漏。

### 5.4 季节划分（seasonal，新增）

```json
"split": { "strategy": "seasonal", "test_seasons": ["Winter"], "ratio": [0.8, 0.2, 0.0] }
```

将指定季节（如冬季）的全部数据划入测试集，其余数据按 `ratio` 比例分为训练/验证。  
- **目的**：测试模型在训练中未见的密度区间上的外推能力；  
- **风险**：训练/测试分布差异大，指标通常比 shuffle 差，属于严格评估。

### 5.5 划分持久化与复用

所有划分结果以 `row_key = timestamp(ns) + index` 为键持久化到 CSV（`split_repo.dir`），后续 run 可通过 `reuse_split_from` 复用相同划分，确保不同实验的训练/验证集完全一致，比较公平。

---

## 6. 评价指标体系

评估分为三个层次，层层递进：

```
① 清洗质量评估
      ↓
② 功率曲线建模精度（val 集）
      ↓
③ 季节稳健性（seasonal 分解）
```

### 6.1 清洗质量指标

| 指标 | 含义 | 计算方式 |
|------|------|---------|
| `rate_pass1` | Pass 1 异常率 | Pass1_异常 数 / scope 样本数 |
| `rate_pass2` | Pass 2 增量异常率 | Pass2_异常 数 / scope 样本数 |
| `rate_total_abn` | 总异常率（P1 ∪ P2） | (P1_abn ∪ P2_abn) / scope |
| `rate_clean` | 清洗后保留率 | 1 - rate_total_abn |
| `n_scope` | 有效样本数 | 规则通过 & 风速在范围内 |

> **注**：当前缺少人工标注的异常真值，无法直接计算 Precision/Recall。可通过以下代理指标间接评估：（1）清洗后验证集 RMSE 是否下降（下降说明异常点确实有害）；（2）不同 tau 参数下的覆盖率曲线。

### 6.2 建模精度指标

在**验证集**（或测试集）的**干净点**（排除 Pass1/Pass2 异常）上计算：

| 指标 | 含义 | 公式 |
|------|------|------|
| RMSE | 均方根误差（功率，kW） | $\sqrt{\frac{1}{n}\sum(y_i - \hat{y}_i)^2}$ |
| MAE | 平均绝对误差（功率，kW） | $\frac{1}{n}\sum\|y_i - \hat{y}_i\|$ |
| R² | 决定系数 | $1 - \frac{\sum(y-\hat{y})^2}{\sum(y-\bar{y})^2}$ |

### 6.3 季节分解指标

对 Spring / Summer / Fall / Winter 四季分别计算 RMSE/MAE/R² 及异常率，用于：

- 验证方法在密度变化最大的冬夏之间的稳健性；
- 发现特定季节的系统性偏差（如冬季低温导致传感器漂移）。

### 6.4 使用评估模块

```python
from stage2_modular.evaluation import summarize_run, compare_runs

# 读取某次实验的所有输出并汇总
result_E = summarize_run("paper_ablation_runs/E_rho_both", split="val")
result_B = summarize_run("paper_ablation_runs/B_no_rho", split="val")

# 生成对比表格
table = compare_runs({"B_no_rho": result_B, "E_rho_both": result_E})
print(table.to_string())
```

---

## 7. 风险与注意事项清单

| 风险项 | 描述 | 应对措施 |
|--------|------|---------|
| **数据泄漏（划分泄漏）** | 不同 run 使用不同划分，导致 val 集信息进入训练 | 使用 `reuse_split_from` 强制复用相同划分；划分 CSV 持久化到 `split_repo` |
| **季节因素混淆** | shuffle 划分下冬夏样本混合，掩盖季节泛化问题 | 增加 seasonal 划分对比（实验 H/I） |
| **共线性（rho 与温度）** | 空气密度与温度高度相关，可能与风速季节模式混淆 | F/G 消融组区分"密度变化"vs"密度均值"的贡献 |
| **KNN 梯度维度不匹配** | `rho_for_clean ≠ rho_for_model` 时 clean 空间与 model 空间维度不同 | 代码已自动检测并降级为 `grad_mode=physics`（日志中会提示） |
| **样本不足** | 某台风机有效样本 < `min_train_samples`（默认 1000），会跳过 | 检查各台风机的 `n_scope`，如需降低阈值需谨慎 |
| **P_rated 估计偏差** | 额定功率由 99.5% 分位估计，若数据中存在大量限电，会低估 | 可在配置中显式设置 `prated`，或先查看功率直方图 |
| **rho 缺失值** | 气象传感器故障时 rho 为 NaN，merge 后丢失样本 | 开启 `force_drop_rho_na`（默认 true）；查看各风机 scope 数量变化 |
| **过拟合/欠拟合** | MLP 深度/宽度不适配，导致残差非平稳 | 检查 val_loss 曲线，必要时调整 `patience`/`epochs`/`hidden` |
| **tau 参数选择** | tau=0.98 意味着约 2% 的"正常点"被标记为异常 | 在论文中报告不同 tau 下的指标曲线，展示鲁棒性 |

---

## 8. 论文结构建议

### 建议章节结构

```
1. Introduction（引言）
   - 风电功率预测的重要性
   - 现有数据清洗方法的局限：忽视空气密度
   - 本文贡献（三点）

2. Related Work（相关工作）
   - 功率曲线建模综述
   - 风电数据清洗方法综述
   - 空气密度在风能领域的已有研究

3. Methodology（方法）
   3.1 空气密度计算（T, P, RH → ρ）
   3.2 两阶段清洗框架（规则 + MLP）
   3.3 KNN 局部分位阈值（三种距离度量）
   3.4 空气密度的双通道引入（rho_for_clean / rho_for_model）

4. Experiments（实验）
   4.1 数据集描述（站点、时间跨度、字段统计）
   4.2 实验设置（超参数、划分策略）
   4.3 主对比实验（A/B/E 三组）
   4.4 消融研究（B/C/D/E，量化各组件贡献）
   4.5 信息有效性验证（E/F/G，排除假象）
   4.6 季节稳健性分析（H/I，seasonal 划分）
   4.7 迭代清洗效果（E/J）

5. Discussion（讨论）
   - 密度对清洗 vs. 建模的差异化贡献
   - 适用场景与局限性
   - 对实际工程的启示

6. Conclusion（结论）

Appendix（附录）
   - 超参数敏感性（tau, K, lambda_t）
   - 不同风机的个体差异分析
```

### 各实验章节的核心图表建议

| 小节 | 推荐图表 |
|------|---------|
| 4.3 主对比 | 表格：A/B/E 在 RMSE/MAE/R²/abn_rate 上的对比 |
| 4.4 消融 | 折线图：B→C→D→E 的 RMSE 递进改善 |
| 4.5 信息有效性 | 条形图：E vs F vs G 的 RMSE，标注误差棒 |
| 4.6 季节稳健性 | 分季节折线图：各方案的 RMSE 随季节变化 |
| 4.7 迭代清洗 | 柱状图：Pass1 vs Pass2 异常率及 RMSE 变化 |

---

## 9. 代码使用指引

### 9.1 运行消融实验

```bash
# 确保已安装依赖并准备好数据
pip install torch numpy pandas

# 运行全部 10 组消融实验
python main.py --config experiments_paper_ablation.json
```

输出结构：

```
paper_ablation_runs/
  _splits/          # 划分缓存（复用确保公平对比）
  A_rules_only/
    JMZSFD_mlp/
      51号机/
        JMZSFD_51号机_stage2_mlp.csv
      ...
  B_no_rho/
  ...
  E_rho_both/
```

### 9.2 生成对比报告

```python
from stage2_modular.evaluation import summarize_run, compare_runs

run_names = ["A_rules_only", "B_no_rho", "C_rho_model_only",
             "D_rho_clean_only", "E_rho_both", "F_rho_shuffle",
             "G_rho_constant", "J_one_pass_rho_both"]

results = {
    name: summarize_run(f"paper_ablation_runs/{name}", split="val")
    for name in run_names
}

# 主对比表格
table = compare_runs(results)
print(table.to_markdown())   # 可直接粘贴到 Markdown 文档

# 季节分解（以 E 组为例）
seasonal = results["E_rho_both"]["seasonal"]
print(seasonal.to_markdown())
```

### 9.3 评估季节泛化实验

```python
# H 和 I 使用 split="test"（冬季测试集）
result_H = summarize_run("paper_ablation_runs/H_seasonal_winter_test", split="test")
result_I = summarize_run("paper_ablation_runs/I_seasonal_winter_test_no_rho", split="test")

seasonal_table = compare_runs({"H_rho_both": result_H, "I_no_rho": result_I})
print(seasonal_table.to_markdown())
```

### 9.4 关键配置参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `rho_for_clean` | false | KNN 清洗是否使用密度作为特征 |
| `rho_for_model` | false | MLP 建模是否使用密度作为输入 |
| `rho_input_mode` | `"normal"` | `normal`/`shuffle`/`constant`，控制消融实验 |
| `cleaning_passes` | 2 | 迭代清洗次数，0=仅规则，1=单次，2=两次 |
| `thresholds.tau_hi` / `tau_lo` | 0.98 | 上/下分位置信水平，越大阈值越宽松（检出越少） |
| `thresholds.k_nei` | 500 | KNN 邻居数，越大越平滑但计算越慢 |
| `thresholds.lambda_t` | 6.0 | tanorm 度量中切向权重，0=纯法向，∞=纯欧氏 |
| `split.strategy` | `"shuffle"` | 划分策略：`shuffle`/`time`/`block_shuffle`/`seasonal` |

---

## 附：实验间依赖关系

```
A_rules_only（生成基准划分）
  ├── B_no_rho          (reuse_split_from: A)
  ├── C_rho_model_only  (reuse_split_from: A)
  ├── D_rho_clean_only  (reuse_split_from: A)
  ├── E_rho_both        (reuse_split_from: A)
  ├── F_rho_shuffle     (reuse_split_from: A)
  ├── G_rho_constant    (reuse_split_from: A)
  └── J_one_pass_rho_both (reuse_split_from: A)

H_seasonal_winter_test       （独立划分，seasonal策略）
I_seasonal_winter_test_no_rho（独立划分，seasonal策略）
```

> **建议**：运行实验时按 JSON 中的顺序执行（A 必须最先），后续实验会自动加载 A 的划分缓存。

---

*本报告由项目配套代码自动分析结构生成，如有修改请同步更新 `experiments_paper_ablation.json`。*

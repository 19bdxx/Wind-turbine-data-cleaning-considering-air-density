# 基准测试使用指南

## 📊 为什么会超时？

### 问题原因

如果您遇到基准测试超时，原因很可能是：

**配置文件包含多个runs**:
- 默认配置 `experiments_compare_不同切向比例_分风机_JSMZS51-58.json` 包含 **20个runs**
- 每个run是一个完整的数据清洗流程（数据加载、训练、预测、评估）
- 每个run需要 3-5 分钟

**基准测试运行4个场景**:
1. 无优化（基线）
2. 仅 KDTree
3. KDTree + 窗口筛选（默认）
4. KDTree + 窗口筛选（宽窗口）

**总耗时计算**:
```
20 runs × 4 场景 × 3-5 分钟/run = 4-5 小时
```

**默认超时**: 2小时

**结果**: 如果配置有很多runs，可能会超时 ❌

---

## ✅ 解决方案

### 方案1: 快速测试模式（推荐）⭐

**使用简化配置，快速验证优化效果**

```bash
python benchmark_knn.py --quick-test
```

**特点**:
- ✅ 只运行 2 个 runs
- ✅ 预计耗时：**5-10 分钟**
- ✅ 足够验证 KNN 优化效果
- ✅ 生成完整的性能对比报告

**原理**:
- 自动使用 `benchmark_config_quick.json`
- 只包含2个代表性runs：
  - `A_rules_only`（基线）
  - `C1_knn_wind_rho_bwR010`（KNN清洗）

### 方案2: 完整测试

**运行所有20个runs，全面性能分析**

```bash
python benchmark_knn.py
```

**特点**:
- 使用完整配置（20个runs）
- 预计耗时：**4-5 小时**
- 适合全面性能分析
- 超时设置为 2 小时（对于非常大的数据集可能仍会超时）

### 方案3: 自定义配置

**创建自己的精简配置**

```bash
python benchmark_knn.py --config my_quick_config.json
```

**步骤**:
1. 复制 `benchmark_config_quick.json`
2. 根据需要调整 runs 数量
3. 运行基准测试

---

## 📝 使用示例

### 快速验证（5-10分钟）

```bash
# 快速测试所有场景
python benchmark_knn.py --quick-test

# 跳过基线，更快（只测试优化场景）
python benchmark_knn.py --quick-test --skip-baseline
```

**输出示例**:
```
⚡ 快速测试模式：使用简化配置（2个runs）
   预计耗时：5-10分钟

🚀 KNN 优化自动化基准测试
基础配置: benchmark_config_quick.json
配置包含: 2 个 runs

======================================================================
运行场景: 无优化（基线）
配置文件: config_benchmark_baseline.json
======================================================================
✅ 完成

======================================================================
运行场景: 仅 KDTree
配置文件: config_benchmark_kdtree_only.json
======================================================================
✅ 完成

... (其他场景)

性能对比总结
================================================================================
场景                      总耗时(秒)   提速比    候选筛除    状态
--------------------------------------------------------------------------------
无优化（基线）            180.45      1.00x     N/A         ✅
仅 KDTree                 165.23      1.09x     N/A         ✅
KDTree + 窗口筛选 (0.1/0.2) 95.67    1.89x     69.5%       ✅
KDTree + 窗口筛选 (0.2/0.3) 115.34   1.56x     54.3%       ✅

✅ 基准测试完成！
```

### 完整测试（4-5小时）

```bash
python benchmark_knn.py
```

**注意**:
- 需要足够时间
- 建议在后台运行或使用 tmux/screen
- 使用 `nohup` 避免中断：
  ```bash
  nohup python benchmark_knn.py > benchmark.log 2>&1 &
  ```

---

## 🎯 基准测试的目的

### ✅ 基准测试应该用于

- **验证 KNN 优化效果**（窗口筛选、KDTree）
- **对比不同优化配置的性能**
- **快速性能评估**（5-15分钟）

### ❌ 基准测试不应该用于

- **运行完整的实验流程**（应该直接使用 `main.py`）
- **生产数据处理**（使用正常的配置和流程）
- **详细的结果分析**（基准测试只关注性能，不做详细分析）

---

## 💡 最佳实践

### 1. 开发阶段

使用快速测试验证优化效果：
```bash
python benchmark_knn.py --quick-test
```

### 2. 性能分析

需要详细性能数据时，使用完整测试：
```bash
python benchmark_knn.py
```

### 3. 自定义测试

根据需要创建精简配置：
```bash
# 复制快速配置为模板
cp benchmark_config_quick.json my_benchmark.json

# 编辑 my_benchmark.json，调整runs数量

# 运行自定义测试
python benchmark_knn.py --config my_benchmark.json
```

### 4. 生产运行

直接使用 main.py，不用 benchmark 脚本：
```bash
python main.py --config experiments_compare_不同切向比例_分风机_JSMZS51-58.json
```

---

## 🔍 故障排查

### 问题：超时

**症状**:
```
❌ 运行超时（2小时）
```

**解决**:
1. 使用 `--quick-test` 模式
2. 或者创建只包含少量runs的配置文件
3. 检查数据集大小（过大的数据集会很慢）

### 问题：内存不足

**症状**:
```
RuntimeError: CUDA out of memory
```

**解决**:
1. 减少批次大小：`knn_batch_q`, `knn_train_chunk`
2. 使用 CPU 模式：`"device": "cpu"`
3. 减少数据规模（turbine范围）

### 问题：没有GPU

**症状**:
```
[Device] torch.cuda.is_available()=False; using=cpu
```

**解决**:
- 这是正常的，系统会自动使用 CPU
- 窗口筛选优化在 CPU 上也有效
- 只是 KDTree 优化仅在 CPU 上工作（GPU 不支持）

---

## 📊 配置文件对比

| 文件 | Runs数量 | 预计耗时 | 适用场景 |
|------|---------|---------|---------|
| `benchmark_config_quick.json` | 2 | 5-10分钟 | 快速验证 ✅ |
| `experiments_compare_不同切向比例_分风机_JSMZS51-58.json` | 20 | 4-5小时 | 全面分析 |

---

## ⏱️ 性能估算

### 单个run的耗时（参考）

根据数据规模和硬件配置：

| 数据规模 | GPU | CPU |
|---------|-----|-----|
| 小（<10K样本） | 1-2分钟 | 2-3分钟 |
| 中（10K-50K） | 2-4分钟 | 4-8分钟 |
| 大（50K-100K） | 4-8分钟 | 8-15分钟 |
| 超大（>100K） | 8-20分钟 | 15-30分钟 |

### 基准测试总耗时

**快速模式**（2 runs × 4 场景）:
```
小数据: 8-16分钟
中数据: 16-32分钟
大数据: 32-64分钟
```

**完整模式**（20 runs × 4 场景）:
```
小数据: 80-160分钟 (1.3-2.7小时)
中数据: 160-320分钟 (2.7-5.3小时)
大数据: 320-640分钟 (5.3-10.7小时)
```

---

## 📞 需要帮助？

如果遇到问题：
1. 查看 [USER_GUIDE.md](USER_GUIDE.md) 了解详细配置
2. 查看 [README.md](README.md) 了解项目概览
3. 检查日志文件：`log_benchmark_*.txt`

---

**建议：开始时使用 `--quick-test` 快速验证，需要详细分析时再运行完整测试。**
